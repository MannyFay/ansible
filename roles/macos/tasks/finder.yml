---
- name: Set Up Finder
  become: true
  become_user: "{{ username }}"
  when: os_type == "macos"
  block:
    - name: Don't show external hard drives on desktop
      community.general.osx_defaults:
        domain: com.apple.finder
        key: ShowExternalHardDrivesOnDesktop
        type: bool
        value: false
        state: present

    - name: Show hidden files
      community.general.osx_defaults:
        domain: com.apple.Finder
        key: AppleShowAllFiles
        type: bool
        value: true
        state: present

    - name: Show all file extensions
      community.general.osx_defaults:
        domain: NSGlobalDomain
        key: AppleShowAllExtensions
        type: bool
        value: true
        state: present

    - name: Show Status Bar
      community.general.osx_defaults:
        domain: com.apple.finder
        key: ShowStatusBar
        type: bool
        value: true
        state: present

    - name: Show Path Bar
      community.general.osx_defaults:
        domain: com.apple.finder
        key: _FXShowPosixPathInTitle
        type: bool
        value: true
        state: present

    - name: Disable extension change warning
      community.general.osx_defaults:
        domain: com.apple.finder
        key: FXEnableExtensionChangeWarning
        type: bool
        value: false
        state: present

    - name: Set Finder view style to Column
      community.general.osx_defaults:
        domain: com.apple.finder
        key: FXPreferredViewStyle
        type: string
        value: Clmv
        state: present

    - name: Don't write .DS_Store files on network volumes
      community.general.osx_defaults:
        domain: com.apple.desktopservices
        key: DSDontWriteNetworkStores
        type: bool
        value: true
        state: present

    - name: Don't write .DS_Store files on USB drives
      community.general.osx_defaults:
        domain: com.apple.desktopservices
        key: DSDontWriteUSBStores
        type: bool
        value: true
        state: present

    - name: Enable text selection in Quick Look
      community.general.osx_defaults:
        domain: com.apple.finder
        key: QLEnableTextSelection
        type: bool
        value: true
        state: present

    - name: Set screenshot location to Desktop
      community.general.osx_defaults:
        domain: com.apple.screencapture
        key: location
        type: string
        value: "$HOME/Desktop"
        state: present

    - name: Set screenshot format to PNG
      community.general.osx_defaults:
        domain: com.apple.screencapture
        key: type
        type: string
        value: "png"
        state: present

    - name: Set navigation services to expand save panel by default
      community.general.osx_defaults:
        domain: NSGlobalDomain
        key: NSNavPanelExpandedStateForSaveMode
        type: bool
        value: true
        state: present

    - name: Set printing dialogue to expand by default
      community.general.osx_defaults:
        domain: NSGlobalDomain
        key: PMPrintingExpandedStateForPrint
        type: bool
        value: true
        state: present

    - name: Set the second printing dialogue to expand by default
      community.general.osx_defaults:
        domain: NSGlobalDomain
        key: PMPrintingExpandedStateForPrint2
        type: bool
        value: true
        state: present

    - name: Quit System Preferences on closing
      community.general.osx_defaults:
        domain: com.apple.systempreferences
        key: NSQuitAlwaysKeepsWindows
        type: bool
        value: false
        state: present

    - name: Remove duplicates in the 'Open With' menu
      ansible.builtin.command: |
        /System/Library/Frameworks/CoreServices. \
        framework/Frameworks/LaunchServices.framework/Support/lsregister \
        -kill -r -domain local -domain system -domain user
      state: present

    - name: Set Desktop View Settings to Grid
      ansible.builtin.command: |
        /usr/libexec/PlistBuddy -c \
        "Set :DesktopViewSettings:IconViewSettings:arrangeBy grid" \
        ~/Library/Preferences/com.apple.finder.plist
      state: present

    - name: Set Standard View Settings to Grid
      ansible.builtin.command: |
        /usr/libexec/PlistBuddy -c \
        "Set :FK_StandardViewSettings:IconViewSettings:arrangeBy grid" \
        ~/Library/Preferences/com.apple.finder.plist
      state: present

    - name: Set Icon View Settings to Grid
      ansible.builtin.command: |
        /usr/libexec/PlistBuddy -c \
        "Set :StandardViewSettings:IconViewSettings:arrangeBy grid" \
        ~/Library/Preferences/com.apple.finder.plist
      state: present

    - name: Empty Bin
      ansible.builtin.command: |
        /bin/rm -rf ~/.Trash/*
      state: present

    - name: Copy empty_bin.sh to Remote Host
      ansible.builtin.copy:
        src: "{{ macos_empty_bin_script }}"
        dest: /usr/local/bin/empty_bin.sh
        mode: "0755"

    - name: Schedule Weekly Cron Job to Empty Trash
      ansible.builtin.cron:
        name: Empty Trash Weekly
        minute: 0
        hour: 12
        job: /usr/local/bin/empty_bin.sh
        state: present

    - name: Copy finder_monitor_disk_space.sh to Remote Host
      ansible.builtin.copy:
        src: "{{ macos_monitor_disk_space_script }}"
        dest: /usr/local/bin/monitor_disk_space.sh
        mode: "0755"

    - name: Add Cron Job for Disk Space Monitoring
      ansible.builtin.cron:
        name: Disk Space Monitoring
        minute: "0"
        hour: "*"
        job: /usr/local/bin/monitor_disk_space.sh

    - name: Notify about Finder setup
      ansible.builtin.debug:
        msg: "Apple macOS Finder setup completed."
